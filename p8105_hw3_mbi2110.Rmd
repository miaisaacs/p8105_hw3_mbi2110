---
title: "Homework 3"
author: "Mia Isaacs"
date: "2024-10-11"
output: github_document
---

# load libraries

```{r}
library(tidyverse)
library(viridis)
library(patchwork)
library(knitr)
```


# question 1

```{r}
library(p8105.datasets)
data("ny_noaa")

summary(ny_noaa)
```


Do some data cleaning. Create separate variables for year, month, and day. Ensure observations for temperature, precipitation, and snowfall are given in reasonable units.

```{r}
noaa_df =  
  janitor::clean_names(ny_noaa) |> 
  mutate(
    year = as.numeric(str_sub(date, 1, 4)),
    month = as.numeric(str_sub(date, 6, 7)),
    day = as.numeric(str_sub(date, 9, 10)),
    prcp = as.numeric(prcp) / 100,
    snow = as.numeric(snow) / 10,
    snwd = as.numeric(snwd) / 10,
    tmax = as.numeric(tmax) / 10,
    tmin = as.numeric(tmin) / 10
  ) |> 
  filter(snow >= 0) |> 
  select(-date)

view(noaa_df)
```

The units for precipitation, snowfall, and snow depth were converted to cm and the unit for max temp and min temp was converted to degrees C.

For snowfall, what are the most commonly observed values? Why?

```{r}
noaa_df |> 
  ggplot(aes(x = snow)) + 
  geom_histogram(binwidth = 10) +
  labs(x = "snowfall (cm)")

mode_snow <- noaa_df |> 
  count(snow, sort = TRUE) |> 
  slice(1) |> 
  pull(snow)

print(mode_snow)
```

The most commonly observed value for snowfall is `r mode_snow` because most days of the year it does not snow in New York.


Make a two-panel plot showing the average max temperature in January and in July in each station across years. Is there any observable / interpretable structure? Any outliers?

```{r}
noaa_df |>
  filter(month == 1 | month == 7) |>
  group_by(year, month) |>
  summarize(avg_tmax = mean(tmax, na.rm = TRUE)) |>
  ggplot(aes(x = year, y = avg_tmax, color = avg_tmax)) +
  geom_point() +
  facet_grid(. ~ factor(month, levels = c(1, 7), labels = c("January", "July"))) +
  scale_color_viridis_c(option = "plasma") +
  labs(y = "average maximum temperature (°C)")
```

It is evident from the two-panel plot that the avg max temp in January ranges between -5ºC and 5ºC, whereas the avg max temp in July ranges between 24ºC and 30ºC. There do not appear to be any outliers in either January or July, although the avg max temps do fluctuate significantly across the years.


Make a two-panel plot showing (i) tmax vs tmin for the full dataset (note that a scatterplot may not be the best option); and (ii) make a plot showing the distribution of snowfall values greater than 0 and less than 100 separately by year.

```{r}
plot_i <- noaa_df |>
  ggplot(aes(x = tmin, y = tmax)) +
  geom_hex() +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "tmax vs. tmin", x = "minimum temperature (°C)", y = "maximum temperature (°C)", fill = "count") +
  theme_minimal()
```

```{r}
plot_ii <- noaa_df |>
  filter(snow > 0 & snow < 100) |>
  ggplot(aes(x = factor(year), y = snow, fill = factor(year))) +  
  geom_violin(alpha = 0.7) +  
  labs(title = "snowfall distribution by year", 
       x = "year", 
       y = "snowfall (cm)", 
       fill = "year") +
  scale_fill_viridis_d(option = "plasma") +
  theme_minimal() +
  theme(axis.text.x = element_blank())
```

```{r}
combined_plot <- plot_i + plot_ii
print(combined_plot)
```


# question 2

Load, tidy, merge, and otherwise organize the data sets. Your final dataset should include all originally observed variables; exclude participants less than 21 years of age, and those with missing demographic data; and encode data with reasonable variable classes (i.e. not numeric, and using factors with the ordering of tables and plots in mind).

```{r}
covar_df =
  read_csv("data/nhanes_covar.csv", skip = 4, na = c("NA", ".", "")) |> 
  janitor::clean_names()

view(covar_df)
```

This dataset contains `r nrow(covar_df)` rows and `r ncol(covar_df)` columns and the variables `r colnames(covar_df)`.

```{r}
accel_df =
  read_csv("data/nhanes_accel.csv", na = c("NA", ".", "")) |> 
  janitor::clean_names()

view(accel_df)
```

This dataset contains `r nrow(accel_df)` rows and `r ncol(accel_df)` columns and the variables min1 to min1440.

```{r}
merged_df =
  left_join(covar_df, accel_df, by = "seqn") |> 
  filter(age >= 21) |> 
  drop_na() |> 
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    age = as.numeric(age),
    bmi = as.numeric(bmi),
    education = factor(education, 
      levels = c(1, 2, 3), 
      labels = c("Less than high school", "High school equivalent", "More than high school"),
      ordered = TRUE),
    across(min1:min1440, as.numeric)
  )

view(merged_df)
```

The covar_df and accel_df datasets were merged to create the merged_df in which there are `r nrow(merged_df)` rows and `r ncol(merged_df)` columns. Those below age 21 or missing demographic data were removed from the data frame. Sex and education were set as factor variables, and age, bmi, and min1-min1440 were set as numeric variables so they will be treated as continuous in analysis and visualization. 


Produce a reader-friendly table for the number of men and women in each education category, and create a visualization of the age distributions for men and women in each education category. Comment on these items.

```{r}
edu_table <- merged_df |> 
  count(education, sex) |> 
  pivot_wider(names_from = sex, values_from = n, values_fill = 0) |> 
  rename("Education Level"= education)

kable(edu_table, format = "markdown", caption = "Number of Men and Women in Each Education Category")
```

The table above shows the frequency of males and females within each education level. Among those with less than a high school education, 27 are males and 28 are females. Among those with a high school equivalent education,  35 are male and 23 are female. Among those with more than a high school education, 56 are male and 59 are female.

```{r}
ggplot(merged_df, aes(x = education, y = age, fill = sex)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  scale_fill_viridis_d(option = "plasma") +
  labs(
    title = "Age Distributions for Men and Women by Education Level",
    x = "Education Level",
    y = "Age",
    fill = "Sex"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

The violin plots showing age distribution by sex and education level reveal that age distributions differ by sex and education level. Most people with less than a high school education are between the ages of about 65 and 75 for both males and females. Among those with a high school equivalent education, the age distribution for males is fairly even and for females contains more people who are between the ages of about 65 and 75. Lastly, for those with more than a high school education, the age distributions show that most people are between the ages of 25 and 45 for both males and females.


Traditional analyses of accelerometer data focus on the total activity over the day. Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant. Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences. Comment on your plot.

```{r}
total_activity <- merged_df |>  
  mutate(total_activity = rowSums(select(merged_df, starts_with('min')), na.rm = TRUE)) |>
  select(-(min1:min1440))

view(total_activity)
```

Data from min1 to min1440 was combined to create total_activity and the extra columns were removed for tidiness.

```{r}
ggplot(total_activity, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = TRUE) +
  facet_wrap(~ education) +
  labs(
    title = "Total Activity vs Age by Sex and Education Level",
    x = "Age",
    y = "Total Activity (MIMs)",
    color = "Sex"
  ) +
  scale_color_viridis_d(option = "plasma") + 
  theme_minimal()
```

The above scatterplots show total activity in MIMS across age, education level, and sex.  It is evident that for both females and males across all education levels, total activity decreases as age increases. For those with less than a high school education, total activity displays a sudden increase around age 55 and subsequently decreases around age 60. For those with a high school equivalent education, total activity increases around age 25 and decreases around age 40, with females achieving significantly more MIMS than males. For those with more than a high school education, total activity is more consistent across age with females achieving more MIMS than males. The distributions for total activity have large spreads for each education level and sex, and there appears to be a significant outlier in the "more than high school" group whose total activity is close to 0 MIMS.


Accelerometer data allows the inspection activity over the course of the day. Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. Describe in words any patterns or conclusions you can make based on this graph; including smooth trends may help identify differences.

```{r}
day_activity <- merged_df |> 
    pivot_longer(
    cols = min1:min1440,
    names_to = "minute",
    values_to = "mims",
    names_prefix = "min"
  )

view(day_activity)
```

Used pivot longer to make MIMS data easier to manipulate into 24-hour time courses.

```{r}
day_activity |> 
  mutate(
    minute = as.numeric(minute),
    hour = (minute - 1) / 60
  ) |> 
  group_by(seqn, hour, sex, education) |> 
  summarize(avg_mims = sum(mims), .groups = "drop") |> 
  
  ggplot(aes(x = hour, y = avg_mims, color = sex)) +
  geom_smooth(se = FALSE) +
  facet_grid(. ~ education) +
  labs(
    title = "24-hour Accelerometer Activity",
    x = "Hour",
    y = "Average MIMS",
    color = "Sex",
  ) +
  theme_minimal() +
  scale_color_viridis_d(option = "plasma") +
  theme(legend.position = "top")
```

To achieve this plot, minutes were aggregated into hour time periods and groups were created to get average activity time, allowing for a cleaner and more interpretable plot. The plot displays average MIMS for each hour of the day stratified by education level and sex. Every group shows a decrease in MIMS within the first five hours of the day (12:00am - 5:00am), a gradual increase between 5:00am and 12:30pm, a gradual decrease between 12:30pm and 8:00pm, and a sharper decrease from 8:00pm until the end of the day (midnight). These consistent patterns reflect the typical 24-hour day in which people wake up in the morning, complete their daily tasks throughout the afternoon, and settle down in the evening before going back to sleep. The plot reflects average MIMS, which includes the range of times that people carry out their normal routines. It is interesting to note that the group with less than high school education has the highest MIMS overall, and females have the highest MIMS across all education levels.


# question 3

Files contain 1% of all rides with a total duration less than 4 hours in each of four months. Import, clean, and tidy these data, and describe the resulting dataset.

```{r}
jan2020 =
  read_csv("data/Jan 2020 Citi.csv") |> 
  janitor::clean_names()

view(jan2020)
```

```{r}
july2020 =
  read_csv("data/July 2020 Citi.csv") |> 
  janitor::clean_names()

view(july2020)
```

```{r}
jan2024 =
  read_csv("data/Jan 2024 Citi.csv") |> 
  janitor::clean_names()

view(jan2024)
```

```{r}
july2024 =
  read_csv("data/July 2024 Citi.csv") |> 
  janitor::clean_names()

view(july2024)
```

Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members. Comment on these results.


Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations.


Make a plot to investigate the effects of day of the week, month, and year on median ride duration. This plot can include one or more panels, but should facilitate comparison across all variables of interest. Comment on your observations from this plot.


There were relatively few electric Citi Bikes in 2020, but many more are available now. For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration. Comment on your results.







